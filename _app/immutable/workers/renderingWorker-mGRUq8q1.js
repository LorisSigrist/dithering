(function(){"use strict";function k(t,e,r){return Math.min(Math.max(t,e),r)}/**
 * @license
 * Copyright 2019 Google LLC
 * SPDX-License-Identifier: Apache-2.0
 */const L=Symbol("Comlink.proxy"),G=Symbol("Comlink.endpoint"),U=Symbol("Comlink.releaseProxy"),C=Symbol("Comlink.finalizer"),w=Symbol("Comlink.thrown"),z=t=>typeof t=="object"&&t!==null||typeof t=="function",X={canHandle:t=>z(t)&&t[L],serialize(t){const{port1:e,port2:r}=new MessageChannel;return A(t,e),[r,[r]]},deserialize(t){return t.start(),B(t)}},Y={canHandle:t=>z(t)&&w in t,serialize({value:t}){let e;return t instanceof Error?e={isError:!0,value:{message:t.message,name:t.name,stack:t.stack}}:e={isError:!1,value:t},[e,[]]},deserialize(t){throw t.isError?Object.assign(new Error(t.value.message),t.value):t.value}},N=new Map([["proxy",X],["throw",Y]]);function q(t,e){for(const r of t)if(e===r||r==="*"||r instanceof RegExp&&r.test(e))return!0;return!1}function A(t,e=globalThis,r=["*"]){e.addEventListener("message",function o(a){if(!a||!a.data)return;if(!q(r,a.origin)){console.warn(`Invalid origin '${a.origin}' for comlink proxy`);return}const{id:c,type:s,path:u}=Object.assign({path:[]},a.data),l=(a.data.argumentList||[]).map(m);let f;try{const g=u.slice(0,-1).reduce((i,d)=>i[d],t),n=u.reduce((i,d)=>i[d],t);switch(s){case"GET":f=n;break;case"SET":g[u.slice(-1)[0]]=m(a.data.value),f=!0;break;case"APPLY":f=n.apply(g,l);break;case"CONSTRUCT":{const i=new n(...l);f=j(i)}break;case"ENDPOINT":{const{port1:i,port2:d}=new MessageChannel;A(t,d),f=Q(i,[i])}break;case"RELEASE":f=void 0;break;default:return}}catch(g){f={value:g,[w]:0}}Promise.resolve(f).catch(g=>({value:g,[w]:0})).then(g=>{const[n,i]=S(g);e.postMessage(Object.assign(Object.assign({},n),{id:c}),i),s==="RELEASE"&&(e.removeEventListener("message",o),H(e),C in t&&typeof t[C]=="function"&&t[C]())}).catch(g=>{const[n,i]=S({value:new TypeError("Unserializable return value"),[w]:0});e.postMessage(Object.assign(Object.assign({},n),{id:c}),i)})}),e.start&&e.start()}function v(t){return t.constructor.name==="MessagePort"}function H(t){v(t)&&t.close()}function B(t,e){return R(t,[],e)}function E(t){if(t)throw new Error("Proxy has been released and is not useable")}function W(t){return h(t,{type:"RELEASE"}).then(()=>{H(t)})}const b=new WeakMap,x="FinalizationRegistry"in globalThis&&new FinalizationRegistry(t=>{const e=(b.get(t)||0)-1;b.set(t,e),e===0&&W(t)});function $(t,e){const r=(b.get(e)||0)+1;b.set(e,r),x&&x.register(t,e,t)}function J(t){x&&x.unregister(t)}function R(t,e=[],r=function(){}){let o=!1;const a=new Proxy(r,{get(c,s){if(E(o),s===U)return()=>{J(a),W(t),o=!0};if(s==="then"){if(e.length===0)return{then:()=>a};const u=h(t,{type:"GET",path:e.map(l=>l.toString())}).then(m);return u.then.bind(u)}return R(t,[...e,s])},set(c,s,u){E(o);const[l,f]=S(u);return h(t,{type:"SET",path:[...e,s].map(g=>g.toString()),value:l},f).then(m)},apply(c,s,u){E(o);const l=e[e.length-1];if(l===G)return h(t,{type:"ENDPOINT"}).then(m);if(l==="bind")return R(t,e.slice(0,-1));const[f,g]=F(u);return h(t,{type:"APPLY",path:e.map(n=>n.toString()),argumentList:f},g).then(m)},construct(c,s){E(o);const[u,l]=F(s);return h(t,{type:"CONSTRUCT",path:e.map(f=>f.toString()),argumentList:u},l).then(m)}});return $(a,t),a}function K(t){return Array.prototype.concat.apply([],t)}function F(t){const e=t.map(S);return[e.map(r=>r[0]),K(e.map(r=>r[1]))]}const V=new WeakMap;function Q(t,e){return V.set(t,e),t}function j(t){return Object.assign(t,{[L]:!0})}function S(t){for(const[e,r]of N)if(r.canHandle(t)){const[o,a]=r.serialize(t);return[{type:"HANDLER",name:e,value:o},a]}return[{type:"RAW",value:t},V.get(t)||[]]}function m(t){switch(t.type){case"HANDLER":return N.get(t.name).deserialize(t.value);case"RAW":return t.value}}function h(t,e,r){return new Promise(o=>{const a=Z();t.addEventListener("message",function c(s){!s.data||!s.data.id||s.data.id!==a||(t.removeEventListener("message",c),o(s.data))}),t.start&&t.start(),t.postMessage(Object.assign({id:a},e),r)})}function Z(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}function tt(t,e){const r=e[0]>>4,o=e[1]>>4,a=e[2]>>4,c=r+(o<<4)+(a<<8),s=c>>6,l=((c&63)<<6|s)<<2;return t.data.slice(l,l|3)}function et(t,e){let r=null,o;const a=()=>{o=new OffscreenCanvas(e.image.width,e.image.height);const n=o.getContext("2d");n==null||n.putImageData(e.image,0,0)};a();const c=t.getContext("2d");if(!c)throw new Error("Could not get canvas context");const s=()=>{c.drawImage(o,0,0,e.output_width,e.output_height);const n=c.getImageData(0,0,e.output_width,e.output_height);for(let i=0;i<e.output_height;i++)for(let d=0;d<e.output_width;d++){const I=i*e.output_width+d<<2,_=n.data.slice(I,I|3),p=tt(e.palette,_);n.data.set(p,I);const rt=(_[0]-p[0])*e.diffusionStrength/2,nt=(_[1]-p[1])*e.diffusionStrength/2,at=(_[2]-p[2])*e.diffusionStrength/2;for(let M=0;M<e.diffusionMatrix.length;M++)for(let P=0;P<e.diffusionMatrix[0].length;P++){const O=d+P-e.diffusionMatrixOriginX,T=i+M;if(O<0||O>=e.output_width||T<0||T>=e.output_height)continue;const y=T*n.width+O<<2,D=e.diffusionMatrix[M][P];n.data[y]=k(n.data[y]+rt*D*e.diffusionStrength,0,255),n.data[y|1]=k(n.data[y|1]+nt*D*e.diffusionStrength,0,255),n.data[y|2]=k(n.data[y|2]+at*D*e.diffusionStrength,0,255)}}c.putImageData(n,0,0)},u=()=>{r===null&&(r=requestAnimationFrame(()=>{r=null,s()}))};return u(),j({update:n=>{const i=n.image!==e.image;e=n,t.width=e.output_width,t.height=e.output_height,i&&a(),u()},updateImage:n=>{e.image=n,a(),u()},destroy:()=>{r!==null&&cancelAnimationFrame(r)}})}A({errorDiffusionDithering:et})})();
